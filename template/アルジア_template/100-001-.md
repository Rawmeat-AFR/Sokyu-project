---
番号: 100-
省庁: 皇府
作成日: <% tp.date.now("YYYY-MM-DD HH:mm:ss") %>
---
<%*
const counterFile = "_system/record_counter.md";

/* ===== frontmatter 取得 ===== */
const prefix = tp.frontmatter["番号"];
if (!prefix || !prefix.endsWith("-")) {
  throw new Error("frontmatter の「番号」が未定義、または '-' で終わっていません");
}

/* ===== カウンタファイル存在確認 ===== */
if (!(await tp.file.exists(counterFile))) {
  await tp.file.write(counterFile, "");
}

let raw = await tp.file.read(counterFile);

/* ===== prefix 行を探す ===== */
const lineRegex = new RegExp(`^${prefix}:\\s*(\\d+)$`, "m");
const match = raw.match(lineRegex);

let nextNumber;
let newRaw;

if (match) {
  const current = parseInt(match[1], 10);
  nextNumber = current + 1;
  newRaw = raw.replace(lineRegex, `${prefix}: ${nextNumber}`);
} else {
  nextNumber = 1;
  newRaw = raw.trimEnd() + `\n${prefix}: ${nextNumber}`;
}

/* ===== カウンタ更新 ===== */
await tp.file.write(counterFile, newRaw.trimStart());

/* ===== 完全な番号を生成 ===== */
const fullNumber = `${prefix}${String(nextNumber).padStart(5, "0")}`;

/* ===== frontmatter 更新 ===== */
tp.frontmatter["番号"] = fullNumber;

/* ===== ファイル名変更（任意だが強く推奨） ===== */
await tp.file.rename(`${fullNumber}_記録`);

%>
